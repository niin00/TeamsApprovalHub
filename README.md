# Teams Approval Hub

A compact Power Platform solution that runs approvals directly in Microsoft Teams, logs every step to Dataverse for audit and KPIs, handles errors with retries, and gives a tiny Power Apps dashboard to reprocess failures. A one-minute demo shows end to end value: intake to approval to insight.

## Table of contents

* [Overview](#overview)
* [Architecture](#architecture)
* [Features](#features)
* [Data model (Dataverse)](#data-model-dataverse)
* [Environment variables](#environment-variables)
* [Prerequisites](#prerequisites)
* [Setup](#setup)
* [Power Automate flows](#power-automate-flows)
* [Adaptive Card example](#adaptive-card-example)
* [Power Apps mini dashboard](#power-apps-mini-dashboard)
* [Demo script](#demo-script)
* [Testing](#testing)
* [Troubleshooting](#troubleshooting)
* [Roadmap](#roadmap)
* [License](#license)

---

## Overview

**Problem**
Approvals are everywhere (small purchases, access requests, vacation). Many teams still bounce between emails and spreadsheets with weak audit trails and no SLA visibility.

**Solution**
Teams Approval Hub turns a simple intake into a tracked approval inside Microsoft Teams. Every step is written to Dataverse for audit and KPIs. Errors are caught, logged, and retried. A small Power App lets an admin re-send failed items. A Power BI page shows approval time, SLA hit rate, and throughput.

---

## Architecture

```
[Intake: Microsoft Forms or SharePoint List]
            |
            v
   [Flow 1: Submit & Approve]
      - Create Request in Dataverse
      - Post Teams Adaptive Card
      - Wait for decision
      - Update status and logs
      - Handle errors and retry
            |
            v
        [Dataverse]
   Requests, ApprovalLogs, ErrorLog
     |                      |
     |                      v
[Power BI Report]   [Flow 3: Retry Orchestrator]
     |
     v
KPIs and SLA

[Flow 2: SLA & Escalation]  --> Teams reminders

[Power Apps mini dashboard] -> browse requests, view logs, re-send failed
```

**Core components**

* **Dataverse** tables: `Requests`, `ApprovalLogs`, `ErrorLog`
* **Power Automate** flows: Submit & Approve, SLA & Escalation, Retry Orchestrator
* **Teams** Adaptive Cards for approval
* **Power Apps** dashboard for operators
* **Power BI** report for KPIs and audit exploration

---

## Features

* Approvals inside Teams with clear buttons (Approve, Reject)
* Full audit log in Dataverse (every step and payload)
* SLA target per request with automatic reminders and escalation
* Robust error handling with retries and operator re-try
* Idempotent design with alternate keys and correlation ids
* Solution packaged with environment variables and connection references

---

## Data model (Dataverse)

**Requests**

| Column         | Type                 | Notes                                    |
| -------------- | -------------------- | ---------------------------------------- |
| RequestId      | GUID (primary)       | Autogenerated                            |
| Title          | Text                 | Short title                              |
| Description    | Multiline text       | Free text                                |
| Amount         | Decimal              | Example field for purchase scenario      |
| Category       | Choice or Text       | Your category taxonomy                   |
| RequestedByUPN | Text                 | Email or UPN                             |
| ApproverUPN    | Text                 | Optional fixed approver or group         |
| Status         | Choice               | New, Pending, Approved, Rejected, Failed |
| CreatedAt      | DateTime             | UTC                                      |
| DueAt          | DateTime             | SLA deadline                             |
| ResolvedAt     | DateTime             | When approved or rejected                |
| TeamsMessageId | Text                 | To update the card or thread             |
| ApprovalId     | Text                 | For idempotency against duplicate runs   |
| CorrelationId  | Text                 | `guid()` per flow run                    |
| RetryCount     | Whole number         | Attempts performed                       |
| ExternalRef    | Text (alternate key) | Optional client idempotency key          |

**ApprovalLogs**

| Column      | Type               | Notes                                                         |
| ----------- | ------------------ | ------------------------------------------------------------- |
| LogId       | GUID (primary)     |                                                               |
| RequestId   | Lookup to Requests |                                                               |
| Step        | Choice             | Created, Sent, Approved, Rejected, Error, Notified, Escalated |
| At          | DateTime           | UTC                                                           |
| ByUPN       | Text               | Actor if known                                                |
| DetailsJSON | Multiline text     | Raw payload for audit                                         |
| FlowRunId   | Text               | From Power Automate context                                   |

**ErrorLog**

| Column       | Type               | Notes                        |
| ------------ | ------------------ | ---------------------------- |
| ErrorId      | GUID (primary)     |                              |
| RequestId    | Lookup to Requests |                              |
| FlowRunId    | Text               |                              |
| ActionName   | Text               | The failed action name       |
| ErrorType    | Text               | HTTP status or platform code |
| Message      | Multiline text     | Short description            |
| RawJSON      | Multiline text     | Error payload                |
| NotifiedAt   | DateTime           | When ops were pinged         |
| ResolvedFlag | Yes/No             | Cleared after success        |

---

## Environment variables

Define these in the solution so you can move across environments without editing flows.

| Name                      | Example                  | Description                            |
| ------------------------- | ------------------------ | -------------------------------------- |
| `EV_TeamsChannelId`       | `19:abc...@thread.tacv2` | Target Teams channel for cards         |
| `EV_ApproverGroupId`      | AAD group id             | Default approver group                 |
| `EV_SLAHours`             | `24`                     | Hours until DueAt                      |
| `EV_ErrorNotifyChannelId` | Teams channel id         | Where ops alerts go                    |
| `EV_IntakeSource`         | `Forms` or `SharePoint`  | Feature flag to switch source          |
| `EV_PlannerPlanId`        | optional                 | If you want a Planner task on approval |

---

## Prerequisites

* Microsoft 365 tenant with **Teams**
* Power Platform environment with **Dataverse**
* Power Automate with access to Approvals, Teams, Dataverse connectors
* Optional **Microsoft Forms** or a **SharePoint List** for intake
* Power BI Pro for publishing the report

---

## Setup

1. **Import solution**

   * Import the managed solution from `/solution/TeamsApprovalHub.zip`.
   * When prompted, create connection references for Dataverse, Teams, Approvals, Forms or SharePoint.

2. **Configure environment variables**

   * Open Solution settings, set each `EV_*` value for your tenant.
   * Example: paste the Teams channel id from the channel’s “Get link to channel”.

3. **Create intake**

   * Option A (Forms): Create a simple form with Title, Description, Amount, Category. Connect it to Flow 1 trigger.
   * Option B (SharePoint): Create a list with equivalent columns. Use “When an item is created” as trigger.

4. **Publish Dataverse tables**

   * Ensure the three tables are present and published.
   * Create an **alternate key** on `Requests.ExternalRef` if you want strong idempotency.

5. **Review flows**

   * Open **Flow 1: Submit & Approve**. Confirm connections, environment variables, and concurrency control.
   * Open **Flow 2: SLA & Escalation**. Set the recurrence to weekday 08:00 local time.
   * Open **Flow 3: Retry Orchestrator**. Set it to manual or daily at 09:00.

6. **Power Apps mini dashboard**

   * Open the app `ApprovalHub Admin`.
   * Check data sources (Requests, ApprovalLogs, ErrorLog).
   * Publish the app and share with your operator group.

7. **Power BI**

   * Open `/powerbi/ApprovalHub.pbix`.
   * Connect to Dataverse tables via the Dataverse connector.
   * Publish to your workspace and configure refresh.

---

## Power Automate flows

### Flow 1: Submit & Approve (event based)

**Trigger**

* New response in Forms (or New item in SharePoint)

**Pattern**

* Use three scopes: **Try**, **Catch**, **Finally**.

**Try**

1. Compose `CorrelationId = guid()`.
2. Create Dataverse `Request` with `Status = Pending`, `DueAt = addHours(utcNow(), EV_SLAHours)`.
3. Post **Adaptive Card** to Teams using `EV_TeamsChannelId`. Store `TeamsMessageId`.
4. Start and wait for approval (single approver or group).
5. On decision, update `Status` to Approved or Rejected, set `ResolvedAt`, and write `ApprovalLogs` at each step.

**Catch** (run after failed or timed out)

* Create `ErrorLog` with `FlowRunId`, `ActionName`, `Message`, and `RawJSON`.
* Increment `Requests.RetryCount`.
* Post a short alert to `EV_ErrorNotifyChannelId`.
* Optionally set `Status = Failed`.

**Finally**

* Notify requester with outcome, or a “we are investigating an error” notice if failed.

**Resilience tips**

* Set **Exponential retry** on Teams and Approvals actions (max 3).
* **Concurrency control**: set degree of parallelism to 1 on the scope that creates Approvals to avoid duplicates.
* **Idempotency**: before creating another approval, check if `ApprovalId` already exists on the Request.
* **429 handling**: optional “Do until” that waits if rate limited.

### Flow 2: SLA & Escalation (scheduled)

* OData filter: `Status eq 'Pending' and DueAt lt @utcNow()`.
* Post a reminder Adaptive Card to the approver group, mention owner.
* Log `Escalated` step to `ApprovalLogs`.

### Flow 3: Retry Orchestrator (manual or scheduled)

* Query `Requests` with `Status = Failed and RetryCount le 3`.
* Re-invoke the relevant sub-actions.
* On success, clear the `Failed` state and append an `Approved` or `Rejected` log entry.

---

## Adaptive Card example

```json
{
  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
  "type": "AdaptiveCard",
  "version": "1.5",
  "body": [
    { "type": "TextBlock", "size": "Large", "weight": "Bolder", "text": "Approval: ${Title}" },
    { "type": "FactSet", "facts": [
      { "title": "Amount", "value": "NOK ${Amount}" },
      { "title": "Category", "value": "${Category}" },
      { "title": "Requester", "value": "${RequestedByUPN}" }
    ]},
    { "type": "TextBlock", "wrap": true, "text": "${Description}" }
  ],
  "actions": [
    { "type": "Action.Submit", "title": "Approve", "data": { "decision": "Approved" } },
    { "type": "Action.Submit", "title": "Reject", "data": { "decision": "Rejected" } }
  ]
}
```

the flow handles the submit payload with the “On card response” trigger and route by `decision`.

---

## Power Apps mini dashboard

Screens:

* **Requests**: gallery filter by Status (Pending, Failed, Approved), search by Title or Category.
* **Details**: shows fields and an embedded subgallery of `ApprovalLogs`.
* **Actions**: button **Re-send** that calls a child flow and increments `RetryCount`.

Power Fx samples:

```fx
// Re-send failed request
Set(
    _ok,
    'paRetryFlow'.Run(ThisItem.RequestId)
);
If(_ok, Notify("Retry sent"), Notify("Retry failed", NotificationType.Error));

// Load logs for a selected request
Filter(ApprovalLogs, RequestId = GalleryRequests.Selected.RequestId)
```

---

**Sample measures**

```DAX
Approvals % = 
DIVIDE(
    CALCULATE(COUNTROWS(Requests), Requests[Status] = "Approved"),
    CALCULATE(COUNTROWS(Requests), Requests[Status] IN {"Approved","Rejected"}),
    0
)

Median Approval Time (hrs) =
MEDIANX(
    FILTER(Requests, NOT(ISBLANK(Requests[ResolvedAt]))),
    DATEDIFF(Requests[CreatedAt], Requests[ResolvedAt], HOUR)
)

SLA Hit % =
DIVIDE(
    CALCULATE(COUNTROWS(Requests),
        Requests[Status] = "Approved",
        Requests[ResolvedAt] <= Requests[DueAt]
    ),
    CALCULATE(COUNTROWS(Requests), Requests[Status] = "Approved"),
    0
)
```

---

## Demo script

1. Submit a new request via the intake form. Keep the title short and include a small Amount.
2. Show the Teams channel. The Adaptive Card appears. Click Approve.
3. Point to the corresponding Request row in Dataverse with updated Status and ResolvedAt. Open ApprovalLogs to show the trail.
4. Open Power BI. Show Median Approval Time and SLA Hit percent. Filter to today.
5. Trigger a controlled error by temporarily breaking a connector, submit again, show the ErrorLog entry and use the Power App to retry.

Duration: about 60 to 90 seconds.

---

## Testing

* Positive path: create, approve, assert `ResolvedAt` and logs exist.
* Rejection path: assert status and logs.
* SLA breach: set `EV_SLAHours = 0.01` in a dev environment to force escalation.
* Idempotency: submit the same `ExternalRef` twice and assert a single approval exists.
* Rate limiting: lower retry caps to make behavior observable in test.

---

## Troubleshooting

| Symptom                         | Likely cause                                      | Fix                                                                       |
| ------------------------------- | ------------------------------------------------- | ------------------------------------------------------------------------- |
| Card never appears in Teams     | Wrong `EV_TeamsChannelId` or connection reference | Rebind the Teams connector, verify channel id                             |
| Duplicate approvals             | Missing idempotency check                         | Use `ApprovalId` guard and an alternate key on `ExternalRef`              |
| Flow fails at Approvals         | Connector throttling or permission                | Enable exponential retry, verify approver license and access              |
| Power BI shows no data          | Security filters or table names differ            | Rebind to Dataverse, check table and field names, refresh gateway if used |
| Retry Orchestrator does nothing | Status not set to Failed or RetryCount exceeded   | Verify the filter and counters, try a manual run with a known RequestId   |

---

## Roadmap

* Multi step approvals (finance then manager)
* PDF receipt to SharePoint on approval
* AI Builder for extracting numbers from attached PDFs
* Planner task creation for approved items
* Data export to long term archive
  
---

## License

